## 9 AUTHENTICATION

## 9.0 Introduction

authentication 인증: 유저가 누구인지
authorization 인가 : 권한, 유저가 보려는 데이터에 접근 권한이 있는지

### Auth Logic

1. Phone Number Sended to Backend --> User ? Login : Sign in (check exist)
2. Login : Create Token -- Connected with User
3. send to token to the Phone(Twillo) --> User receive Token(Random Number) by SMS
4. Client submit that Token --> Send Token to Backend --> if token correct, Authenticate

## 9.1 Accounts Logic

테스트하기전에 pscale connect 우선으로 실행하기!!!
`pscale connect carrot-market`

무언가를 만들고 존재하는 데이터가 있다면 db에서 가져오는 작업을 많이함.
`upsert` : 만들 때(`create`) 사용하지않고 생성(`inserte`)하거나 수정(`update`)할때 사용함

아래의 코드가 너무 길다! 보기 힘들다!! 개발자, 사용자 편의성을 챙기자!
=> `client.user.upsert({})`사용

```tsx
import client from "@libs/server/client";

async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { phone, email } = req.body;
  if (email) {
    user = await client.user.findUnique({
      where: {
        email,
      },
    });
    if (user) console.log("found it.");
    if (!user) {
      console.log("Did not find. Will create.");
      user = await client.user.create({
        data: {
          name: "Anonymous",
          email,
        },
      });
    }
    console.log(user);
  }
  if (phone) {
    user = await client.user.findUnique({
      where: {
        phone: +phone,
      },
    });
    if (user) console.log("found it.");
    if (!user) {
      console.log("Did not find. Will create.");
      user = await client.user.create({
        data: {
          name: "Anonymous",
          phone: +phone,
        },
      });
    }
    console.log(user);
  }
  return res.status(200).end();
}
```

[Update or create records](https://www.prisma.io/docs/concepts/components/prisma-client/crud#update-or-create-records)
[(upsert)](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference#upsert)

`upsert()`는 기존 데이터를 업데이트하거나 새 데이터베이스 레코드를 생성함.
다음 쿼리는 upsert를 사용하여 특정 이메일 주소로 사용자 레코드를 업데이트하거나, 존재하지 않는 경우 해당 사용자 레코드를 생성함.

```ts
const upsertUser = await prisma.user.upsert({
  where: {
    email: "hello@gmail.com", // email이 존재하는지 찾고, 존재하면 update 실행
  },
  update: {
    name: "pizza",
  },
  create: {
    email: "hello@gmail.com", // email이 존재하지 않다면 생성
    name: "pizza",
  },
});
```

PlanetScale 데이터베이스 연결
`pscale connect carrot-market`

## 9.2 Token Logic

## 9.3 Twilo Setup

## 9.4 Sending SMS

## 9.5 Sending Email

## 9.6 Token UI

## 9.7 Serverless Sessions

## 9.8 Profile Handler

## 9.9 Cleaning Code

## 9.10 NextAuth
